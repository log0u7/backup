#!/usr/bin/env bash

set -e

if [[ -n "${DEBUG}" ]]; then
  set -x
fi

provider=$1
scope=$2
key=$3
secret=$4
dir=$5
exclude_paths=$6
mark=$7
bucket=$8
destination=$9
max_concurrent_requests=${10}
max_bandwidth=${11}
storage_class=${12}

case "${provider}" in
"aws")
  if [[ -z "${secret}" ]]; then
    >&2 echo "Missing AWS secret access key"
    exit 1
  fi
  AWS_ACCESS_KEY_ID=${key} AWS_SECRET_ACCESS_KEY=${secret} backup_and_upload_aws \
    "${dir}" "${exclude_paths}" "${mark}" \
    "${scope}" "${bucket}" "${destination}" \
    "${max_concurrent_requests}" "${max_bandwidth}" "${storage_class}"
  ;;
"gcp")
  if [[ ! -f "${key}" ]]; then
    echo "${key}" | base64 -d > /tmp/sa.json
    key=/tmp/sa.json
  fi
  backup_and_upload_gcp \
    "${dir}" "${exclude_paths}" "${mark}" \
     "${key}" "${scope}" "${bucket}" "${destination}" "${storage_class}"
  ;;
*)
  exit 1
  ;;
esac
